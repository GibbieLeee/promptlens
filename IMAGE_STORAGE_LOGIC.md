# –õ–æ–≥–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## üìã –û–±–∑–æ—Ä

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**:
1. **Firebase Storage** - –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
2. **Data URL (–º–∏–Ω–∏–∞—Ç—é—Ä—ã)** - –∫–∞–∫ fallback –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å Storage

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª
    ‚Üì
–°–æ–∑–¥–∞–µ—Ç—Å—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞ (Data URL) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    ‚Üì
–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (uploadedFilesRef)
    ‚Üì
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ UI —á–µ—Ä–µ–∑ Data URL
```

### 2. –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞

```
–ü—Ä–æ–º–ø—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
    ‚Üì
–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Firebase Storage
    ‚Üì
    ‚îú‚îÄ ‚úÖ –£—Å–ø–µ—Ö ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è Storage URL –≤ Firestore
    ‚îî‚îÄ ‚ùå –û—à–∏–±–∫–∞ (CORS) ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è Data URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã –≤ Firestore
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
    ‚Üì
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ Storage —Å ID: "saved-{promptId}"
    (—Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–ø–∏—è, –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –æ—Ç —á–∞—Ç–∞)
    ‚Üì
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é savedPrompts
    ‚Üì
‚úÖ –ß–∞—Ç –∏ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã!
```

### 4. –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ "–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ"

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    ‚Üì
–£–¥–∞–ª—è–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ savedPrompts
    ‚Üì
‚úÖ –£–¥–∞–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "saved-{promptId}.webp" –∏–∑ Storage
    ‚Üì
‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º!
    (—É –Ω–µ–≥–æ –¥—Ä—É–≥–æ–π ID: {messageId}.webp)
```

### 5. –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞
    ‚Üì
–£–¥–∞–ª—è–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ chatHistory
    ‚Üì
‚úÖ –£–¥–∞–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "{messageId}.webp" –∏–∑ Storage
    ‚Üì
‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º!
    (—É –Ω–µ–≥–æ –¥—Ä—É–≥–æ–π ID: saved-{promptId}.webp)
```

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### Firestore: `users/{userId}/chatHistory/{messageId}`
```javascript
{
  imageUrl: "https://storage.googleapis.com/..." –∏–ª–∏ "data:image/webp;base64,...",
  prompt: "...",
  status: "done",
  phases: [],
  timestamp: Timestamp
}
```

### Firestore: `users/{userId}/savedPrompts/{promptId}`
```javascript
{
  imageUrl: "https://storage.googleapis.com/..." –∏–ª–∏ "data:image/webp;base64,...",
  prompt: "...",
  timestamp: Timestamp
}
```

### Firebase Storage

**–ß–∞—Ç:** `users/{userId}/images/{messageId}.webp`
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
- –£–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞

**–ò–∑–±—Ä–∞–Ω–Ω–æ–µ:** `users/{userId}/images/saved-{promptId}.webp`
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
- –£–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
- **–ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –æ—Ç —á–∞—Ç–∞**

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∂–∞—Ç–∏—è:**
- –§–æ—Ä–º–∞—Ç: WebP
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1200x1200px
- –ö–∞—á–µ—Å—Ç–≤–æ: 85%

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### ‚úÖ DO (–î–µ–ª–∞—Ç—å):
1. **–í—Å–µ–≥–¥–∞** —Å–æ—Ö—Ä–∞–Ω—è—Ç—å Data URL –∫–∞–∫ fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ Storage
2. **–°–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —á–∞—Ç–∞ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (—Ä–∞–∑–Ω—ã–µ ID)
3. **–£–¥–∞–ª—è—Ç—å** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–∞—Ç–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ —á–∞—Ç–∞ (`{messageId}.webp`)
4. **–£–¥–∞–ª—è—Ç—å** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (`saved-{promptId}.webp`)
5. **–ü—Ä–æ–≤–µ—Ä—è—Ç—å** –Ω–∞–ª–∏—á–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

### ‚ùå DON'T (–ù–µ –¥–µ–ª–∞—Ç—å):
1. **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –¥–ª—è —á–∞—Ç–∞ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
2. **–ù–ï —É–¥–∞–ª—è—Ç—å** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∞—Ç–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
3. **–ù–ï —É–¥–∞–ª—è—Ç—å** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ —á–∞—Ç–∞
4. **–ù–ï –ø–æ–ª–∞–≥–∞—Ç—å—Å—è** —Ç–æ–ª—å–∫–æ –Ω–∞ Storage (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ CORS)
5. **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è—Ç—å** –æ–≥—Ä–æ–º–Ω—ã–µ Data URL (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∂–∞—Ç–∏–µ)

---

## üêõ –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—á–µ–∑–∞—é—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
**–ü—Ä–∏—á–∏–Ω–∞:** Data URL –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Firestore  
**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - —Ç–µ–ø–µ—Ä—å Data URL —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ fallback

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—á–µ–∑–∞—é—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
**–ü—Ä–∏—á–∏–Ω–∞:** –ß–∞—Ç –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Storage  
**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —Å —Ä–∞–∑–Ω—ã–º–∏ ID:
- –ß–∞—Ç: `{messageId}.webp`
- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: `saved-{promptId}.webp`

### –ü—Ä–æ–±–ª–µ–º–∞: CORS –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ Storage
**–ü—Ä–∏—á–∏–Ω–∞:** Firebase Storage —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS  
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å `gsutil cors set cors.json gs://YOUR_BUCKET` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Data URL fallback

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä Firestore –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
**–ü—Ä–∏—á–∏–Ω–∞:** Data URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã –∑–∞–Ω–∏–º–∞—é—Ç ~3-5 KB  
**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º–æ. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –¥–ª—è Storage

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Storage URL | Data URL |
|----------|-------------|----------|
| **–†–∞–∑–º–µ—Ä –≤ Firestore** | ~150 bytes | ~3-5 KB |
| **–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏** | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ—Ç–∏ | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | –¢—Ä–µ–±—É–µ—Ç CORS | –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **–ö–∞—á–µ—Å—Ç–≤–æ** | –í—ã—Å–æ–∫–æ–µ (1200px) | –°—Ä–µ–¥–Ω–µ–µ (400-800px) |
| **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è** | ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | ‚úÖ Fallback |

---

## üîß –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

### `uploadImage(file, userId, imageId)`
- –°–∂–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ WebP
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ Storage –ø–æ –ø—É—Ç–∏ `users/{userId}/images/{imageId}.webp`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Storage URL

### `deleteImage(userId, imageId)`
- –£–¥–∞–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ Storage
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ —á–∞—Ç–∞

### `saveChatMessage(userId, messageData)`
- –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ Storage
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç Data URL
- –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–∫–æ–µ-—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

### `savePrompt(userId, promptData)`
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π URL (Storage –∏–ª–∏ Data)
- –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ Storage

### `deleteSavedPrompt(userId, promptId)`
- –£–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ Firestore
- –ù–ï —É–¥–∞–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ Storage

---

## üéØ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤ –±—É–¥—É—â–µ–º

1. **Lazy loading** - –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
2. **CDN** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CDN –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
3. **–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å orphaned images
4. **–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å placeholder ‚Üí –º–∏–Ω–∏–∞—Ç—é—Ä—É ‚Üí –ø–æ–ª–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024-12-19  
**–í–µ—Ä—Å–∏—è:** 5.0.1

